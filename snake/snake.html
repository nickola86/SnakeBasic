<!DOCTYPE HTML>
<html>
  <head>
  <script type="text/javascript" src="../commons/js/jquery-1.7.1.min.js"></script>
  <script type="text/javascript" src="../commons/js/jquery-ui-1.8.17.custom.min.js"></script>
  <script>
    
    var xPos = 0;
    var yPos = 0;
    var direction = 'right';
    var maxWidth; 
    var maxHeight;  
    var squareSize = 20; 
    var xRandom;
    var yRandom; 
    var timer; 
    var snake = [];
    var interval = 100;
    
    $(document).ready(function(){
	        
        maxWidth  = parseInt($("#square").attr("width")); 
	    maxHeight = parseInt($("#square").attr("height"));
	      
	    //disegno il serpente iniziale
	    drawInitialSnake();
	      
        timer = setInterval(function(){step();}, interval);
	      
	    $(document).keyup(function(e){catchArrowKeydown(e.keyCode)});
        
        generateRandomSquare();
        
    });
   
    
    function drawInitialSnake(){
		snake.push({x:0,
					y:0
				   },
				   {x:20,
					y:0
				   },
				   {x:40,
					y:0
				   });
		for (var i = 0; i<snake.length; i++){
			drawSquare("#AE1", snake[i].x, snake[i].y);
		}  
    }
    
    function updateDataModel(){
    
       xStr = "";
       yStr = "";
       
       for (i = 0; i<=snake.length-2; i++){       
          snake[i].x = snake[i+1].x;
          snake[i].y = snake[i+1].y;
       }
       
       snake[snake.length-1].x = xPos;
       snake[snake.length-1].y = yPos;
       
       for (i = 0 ; i < snake.length -1 ; i++){
        xStr = xStr + " " + snake[i].x;
        yStr = yStr + " " + snake[i].y;
       }
    }
    
    function drawFinalSquare(){
    
      x = snake[snake.length-1].x;
      y = snake[snake.length-1].y;
      
      gameOver = false;
      
      if (direction == 'right'){
      
        x = x + squareSize;
        
        if (x >= maxWidth)
          gameOver = true;
          
      } else if (direction == 'left'){
      
        x = x - squareSize;
        
        if (x < 0)
          gameOver = true;
          
      } else if (direction == 'up'){
      
        y = y - squareSize;
      
        if (y < 0)
          gameOver = true;
          
      } else if (direction == 'down'){
        
        y = y + squareSize;
        
        if (y >= maxHeight)
          gameOver = true;
      } 

      //salvo le coordinate
      xPos = x;
      yPos = y;

      
      if (gameOver == true) {
        clearInterval(timer);
        alert("Game over :(");
      }
      else {
		checkMangiato();
        drawSquare("#AE1", x, y);
      } 
      
     
    }
    
    function eraseFirstSquare(){
          drawSquare("#FFF",snake[0].x, snake[0].y);
    }
    
    function step(){
    
      //Recupero le coordinate del quadrato in coda e lo cancello
      eraseFirstSquare();
      
      //Recupero le coordinate del quadrato in testa e ne disegno uno nuovo a seconda della direzione
      drawFinalSquare();
      
      //Traslo il vettore in modo da cancellare l'elemento in coda e salvare le nuove coordinate in testa
      updateDataModel();
      
    }
     
    function drawSquare(color, x, y){
      var canvas = document.getElementById("square");
      var context = canvas.getContext("2d");
      context.fillStyle = color; 
      context.fillRect(x, y, squareSize, squareSize);
    }
    
    function generateRandomSquare(){
    
      xRandom = Math.floor(Math.random() * maxWidth / squareSize) * squareSize;
      yRandom = Math.floor(Math.random() * maxHeight / squareSize) * squareSize;
      
      drawSquare("#FAA", xRandom, yRandom);
    }
    
    function checkMangiato(){
    
      
      if (xRandom == xPos && yRandom == yPos){
        generateRandomSquare();
        snake.push({x:xPos,y:yPos});
        punteggio = snake.length - 1;
        $("#count").html(punteggio);     
      }
    }
    
    function catchArrowKeydown(keyCode){
     
      if (keyCode==37 && direction != 'right'){
  		
  		  direction = 'left'; 
  		  
  		} else if (keyCode==38 && direction != 'down'){
  			
  			direction = 'up';   
         
  		} else if (keyCode==39 && direction != 'left'){
  			
  			direction = 'right';  
  			
  		} else if (keyCode==40 && direction != 'top'){
  			
  		  direction = 'down'; 
  		}
    }
  
   </script>
  </head>
  <body>
    
  <canvas id="square" width="1000" height="500" style="border: 1px solid"></canvas>
  <div>
    Punteggio: <span id="count">0</span></br> 
    Livello: <span id="interval">1</span>
  </div>
  
    
  </body>
</html>